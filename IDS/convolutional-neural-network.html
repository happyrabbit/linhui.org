<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>12.2 Convolutional Neural Network | Practitioner’s Guide to Data Science</title>
  <meta name="description" content="Introduction to Data Science" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="12.2 Convolutional Neural Network | Practitioner’s Guide to Data Science" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://scientistcafe.com/IDS/" />
  
  <meta property="og:description" content="Introduction to Data Science" />
  <meta name="github-repo" content="happyrabbit/IntroDataScience" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="12.2 Convolutional Neural Network | Practitioner’s Guide to Data Science" />
  
  <meta name="twitter:description" content="Introduction to Data Science" />
  

<meta name="author" content="Hui Lin and Ming Li" />


<meta name="date" content="2023-02-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="feedforward-neural-network.html"/>
<link rel="next" href="recurrent-neural-network.html"/>
<script src="libs/header-attrs/header-attrs.js"></script>
<script src="libs/jquery/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="http://scientistcafe.com">Homepage</a></li>

<li class="divider"></li>
<li><a href="index.html#preface" id="toc-preface">Preface</a>
<ul>
<li><a href="goal-of-the-book.html#goal-of-the-book" id="toc-goal-of-the-book">Goal of the Book</a></li>
<li><a href="what-this-book-covers.html#what-this-book-covers" id="toc-what-this-book-covers">What This Book Covers</a></li>
<li><a href="who-this-book-is-for.html#who-this-book-is-for" id="toc-who-this-book-is-for">Who This Book Is For</a></li>
<li><a href="how-to-use-this-book.html#how-to-use-this-book" id="toc-how-to-use-this-book">How to Use This Book</a>
<ul>
<li><a href="how-to-use-this-book.html#what-the-book-assumes" id="toc-what-the-book-assumes">What the Book Assumes</a></li>
<li><a href="how-to-use-this-book.html#how-to-run-r-and-python-code" id="toc-how-to-run-r-and-python-code">How to Run R and Python Code</a></li>
</ul></li>
<li><a href="complementary-reading.html#complementary-reading" id="toc-complementary-reading">Complementary Reading</a></li>
</ul></li>
<li><a href="about-the-authors.html#about-the-authors" id="toc-about-the-authors">About the Authors</a></li>
<li><a href="introduction.html#introduction" id="toc-introduction"><span class="toc-section-number">1</span> Introduction</a>
<ul>
<li><a href="a-brief-history-of-data-science.html#a-brief-history-of-data-science" id="toc-a-brief-history-of-data-science"><span class="toc-section-number">1.1</span> A Brief History of Data Science</a></li>
<li><a href="data-science-role-and-skill-tracks.html#data-science-role-and-skill-tracks" id="toc-data-science-role-and-skill-tracks"><span class="toc-section-number">1.2</span> Data Science Role and Skill Tracks</a>
<ul>
<li><a href="data-science-role-and-skill-tracks.html#engineering" id="toc-engineering"><span class="toc-section-number">1.2.1</span> Engineering</a></li>
<li><a href="data-science-role-and-skill-tracks.html#analysis" id="toc-analysis"><span class="toc-section-number">1.2.2</span> Analysis</a></li>
<li><a href="data-science-role-and-skill-tracks.html#modelinginference" id="toc-modelinginference"><span class="toc-section-number">1.2.3</span> Modeling/Inference</a></li>
</ul></li>
<li><a href="what-kind-of-questions-can-data-science-solve.html#what-kind-of-questions-can-data-science-solve" id="toc-what-kind-of-questions-can-data-science-solve"><span class="toc-section-number">1.3</span> What Kind of Questions Can Data Science Solve?</a>
<ul>
<li><a href="what-kind-of-questions-can-data-science-solve.html#prerequisites" id="toc-prerequisites"><span class="toc-section-number">1.3.1</span> Prerequisites</a></li>
<li><a href="what-kind-of-questions-can-data-science-solve.html#problem-type" id="toc-problem-type"><span class="toc-section-number">1.3.2</span> Problem Type</a></li>
</ul></li>
<li><a href="structure-of-data-science-team.html#structure-of-data-science-team" id="toc-structure-of-data-science-team"><span class="toc-section-number">1.4</span> Structure of Data Science Team</a></li>
<li><a href="data-science-roles.html#data-science-roles" id="toc-data-science-roles"><span class="toc-section-number">1.5</span> Data Science Roles</a></li>
</ul></li>
<li><a href="SoftSkillsforDataScientists.html#SoftSkillsforDataScientists" id="toc-SoftSkillsforDataScientists"><span class="toc-section-number">2</span> Soft Skills for Data Scientists</a>
<ul>
<li><a href="comparison-between-statistician-and-data-scientist.html#comparison-between-statistician-and-data-scientist" id="toc-comparison-between-statistician-and-data-scientist"><span class="toc-section-number">2.1</span> Comparison between Statistician and Data Scientist</a></li>
<li><a href="beyond-data-and-analytics.html#beyond-data-and-analytics" id="toc-beyond-data-and-analytics"><span class="toc-section-number">2.2</span> Beyond Data and Analytics</a></li>
<li><a href="three-pillars-of-knowledge.html#three-pillars-of-knowledge" id="toc-three-pillars-of-knowledge"><span class="toc-section-number">2.3</span> Three Pillars of Knowledge</a></li>
<li><a href="data-science-project-cycle.html#data-science-project-cycle" id="toc-data-science-project-cycle"><span class="toc-section-number">2.4</span> Data Science Project Cycle</a>
<ul>
<li><a href="data-science-project-cycle.html#types-of-data-science-projects" id="toc-types-of-data-science-projects"><span class="toc-section-number">2.4.1</span> Types of Data Science Projects</a></li>
<li><a href="data-science-project-cycle.html#ProblemFormulationandProjectPlanningStage" id="toc-ProblemFormulationandProjectPlanningStage"><span class="toc-section-number">2.4.2</span> Problem Formulation and Project Planning Stage</a></li>
<li><a href="data-science-project-cycle.html#project-modeling-stage" id="toc-project-modeling-stage"><span class="toc-section-number">2.4.3</span> Project Modeling Stage</a></li>
<li><a href="data-science-project-cycle.html#ModelImplementationandPostProductionStage" id="toc-ModelImplementationandPostProductionStage"><span class="toc-section-number">2.4.4</span> Model Implementation and Post Production Stage</a></li>
<li><a href="data-science-project-cycle.html#ProjectCycleSummary" id="toc-ProjectCycleSummary"><span class="toc-section-number">2.4.5</span> Project Cycle Summary</a></li>
</ul></li>
<li><a href="common-mistakes-in-data-science.html#common-mistakes-in-data-science" id="toc-common-mistakes-in-data-science"><span class="toc-section-number">2.5</span> Common Mistakes in Data Science</a>
<ul>
<li><a href="common-mistakes-in-data-science.html#problem-formulation-stage" id="toc-problem-formulation-stage"><span class="toc-section-number">2.5.1</span> Problem Formulation Stage</a></li>
<li><a href="common-mistakes-in-data-science.html#project-planning-stage" id="toc-project-planning-stage"><span class="toc-section-number">2.5.2</span> Project Planning Stage</a></li>
<li><a href="common-mistakes-in-data-science.html#project-modeling-stage-1" id="toc-project-modeling-stage-1"><span class="toc-section-number">2.5.3</span> Project Modeling Stage</a></li>
<li><a href="common-mistakes-in-data-science.html#model-implementation-and-post-production-stage" id="toc-model-implementation-and-post-production-stage"><span class="toc-section-number">2.5.4</span> Model Implementation and Post Production Stage</a></li>
<li><a href="common-mistakes-in-data-science.html#summary-of-common-mistakes" id="toc-summary-of-common-mistakes"><span class="toc-section-number">2.5.5</span> Summary of Common Mistakes</a></li>
</ul></li>
</ul></li>
<li><a href="introduction-to-the-data.html#introduction-to-the-data" id="toc-introduction-to-the-data"><span class="toc-section-number">3</span> Introduction to The Data</a>
<ul>
<li><a href="customer-data-for-a-clothing-company.html#customer-data-for-a-clothing-company" id="toc-customer-data-for-a-clothing-company"><span class="toc-section-number">3.1</span> Customer Data for A Clothing Company</a></li>
<li><a href="swinediseasedata.html#swinediseasedata" id="toc-swinediseasedata"><span class="toc-section-number">3.2</span> Swine Disease Breakout Data</a></li>
<li><a href="mnist-dataset.html#mnist-dataset" id="toc-mnist-dataset"><span class="toc-section-number">3.3</span> MNIST Dataset</a></li>
<li><a href="imdb-dataset.html#imdb-dataset" id="toc-imdb-dataset"><span class="toc-section-number">3.4</span> IMDB Dataset</a></li>
</ul></li>
<li><a href="bigdatacloudplatform.html#bigdatacloudplatform" id="toc-bigdatacloudplatform"><span class="toc-section-number">4</span> Big Data Cloud Platform</a>
<ul>
<li><a href="power-of-cluster-of-computers.html#power-of-cluster-of-computers" id="toc-power-of-cluster-of-computers"><span class="toc-section-number">4.1</span> Power of Cluster of Computers</a></li>
<li><a href="evolution-of-cluster-computing.html#evolution-of-cluster-computing" id="toc-evolution-of-cluster-computing"><span class="toc-section-number">4.2</span> Evolution of Cluster Computing</a>
<ul>
<li><a href="evolution-of-cluster-computing.html#hadoop" id="toc-hadoop"><span class="toc-section-number">4.2.1</span> Hadoop</a></li>
<li><a href="evolution-of-cluster-computing.html#spark" id="toc-spark"><span class="toc-section-number">4.2.2</span> Spark</a></li>
</ul></li>
<li><a href="CloudEnvironment.html#CloudEnvironment" id="toc-CloudEnvironment"><span class="toc-section-number">4.3</span> Introduction of Cloud Environment</a>
<ul>
<li><a href="CloudEnvironment.html#open-account-and-create-a-cluster" id="toc-open-account-and-create-a-cluster"><span class="toc-section-number">4.3.1</span> Open Account and Create a Cluster</a></li>
<li><a href="CloudEnvironment.html#r-notebook" id="toc-r-notebook"><span class="toc-section-number">4.3.2</span> R Notebook</a></li>
<li><a href="CloudEnvironment.html#markdown-cells" id="toc-markdown-cells"><span class="toc-section-number">4.3.3</span> Markdown Cells</a></li>
</ul></li>
<li><a href="leveragesparkr.html#leveragesparkr" id="toc-leveragesparkr"><span class="toc-section-number">4.4</span> Leverage Spark Using R Notebook</a></li>
<li><a href="databases-and-sql.html#databases-and-sql" id="toc-databases-and-sql"><span class="toc-section-number">4.5</span> Databases and SQL</a>
<ul>
<li><a href="databases-and-sql.html#history" id="toc-history"><span class="toc-section-number">4.5.1</span> History</a></li>
<li><a href="databases-and-sql.html#database-table-and-view" id="toc-database-table-and-view"><span class="toc-section-number">4.5.2</span> Database, Table and View</a></li>
<li><a href="databases-and-sql.html#basic-sql-statement" id="toc-basic-sql-statement"><span class="toc-section-number">4.5.3</span> Basic SQL Statement</a></li>
<li><a href="databases-and-sql.html#advanced-topics-in-database" id="toc-advanced-topics-in-database"><span class="toc-section-number">4.5.4</span> Advanced Topics in Database</a></li>
</ul></li>
</ul></li>
<li><a href="datapreprocessing.html#datapreprocessing" id="toc-datapreprocessing"><span class="toc-section-number">5</span> Data Pre-processing</a>
<ul>
<li><a href="data-cleaning.html#data-cleaning" id="toc-data-cleaning"><span class="toc-section-number">5.1</span> Data Cleaning</a></li>
<li><a href="missing-values.html#missing-values" id="toc-missing-values"><span class="toc-section-number">5.2</span> Missing Values</a>
<ul>
<li><a href="missing-values.html#impute-missing-values-with-medianmode" id="toc-impute-missing-values-with-medianmode"><span class="toc-section-number">5.2.1</span> Impute missing values with median/mode</a></li>
<li><a href="missing-values.html#k-nearest-neighbors" id="toc-k-nearest-neighbors"><span class="toc-section-number">5.2.2</span> K-nearest neighbors</a></li>
<li><a href="missing-values.html#bagging-tree" id="toc-bagging-tree"><span class="toc-section-number">5.2.3</span> Bagging Tree</a></li>
</ul></li>
<li><a href="centering-and-scaling.html#centering-and-scaling" id="toc-centering-and-scaling"><span class="toc-section-number">5.3</span> Centering and Scaling</a></li>
<li><a href="resolve-skewness.html#resolve-skewness" id="toc-resolve-skewness"><span class="toc-section-number">5.4</span> Resolve Skewness</a></li>
<li><a href="outliers.html#outliers" id="toc-outliers"><span class="toc-section-number">5.5</span> Resolve Outliers</a></li>
<li><a href="collinearity.html#collinearity" id="toc-collinearity"><span class="toc-section-number">5.6</span> Collinearity</a></li>
<li><a href="sparse-variables.html#sparse-variables" id="toc-sparse-variables"><span class="toc-section-number">5.7</span> Sparse Variables</a></li>
<li><a href="re-encode-dummy-variables.html#re-encode-dummy-variables" id="toc-re-encode-dummy-variables"><span class="toc-section-number">5.8</span> Re-encode Dummy Variables</a></li>
</ul></li>
<li><a href="datawrangline.html#datawrangline" id="toc-datawrangline"><span class="toc-section-number">6</span> Data Wrangling</a>
<ul>
<li><a href="summarize-data.html#summarize-data" id="toc-summarize-data"><span class="toc-section-number">6.1</span> Summarize Data</a>
<ul>
<li><a href="summarize-data.html#dplyr-package" id="toc-dplyr-package"><span class="toc-section-number">6.1.1</span> <code>dplyr</code> package</a></li>
<li><a href="summarize-data.html#applyfamilyinbaser" id="toc-applyfamilyinbaser"><span class="toc-section-number">6.1.2</span> <code>apply()</code>, <code>lapply()</code> and <code>sapply()</code> in base R</a></li>
</ul></li>
<li><a href="tidy-and-reshape-data.html#tidy-and-reshape-data" id="toc-tidy-and-reshape-data"><span class="toc-section-number">6.2</span> Tidy and Reshape Data</a></li>
</ul></li>
<li><a href="modeltuningstrategy.html#modeltuningstrategy" id="toc-modeltuningstrategy"><span class="toc-section-number">7</span> Model Tuning Strategy</a>
<ul>
<li><a href="vbtradeoff.html#vbtradeoff" id="toc-vbtradeoff"><span class="toc-section-number">7.1</span> Variance-Bias Trade-Off</a></li>
<li><a href="datasplittingresampling.html#datasplittingresampling" id="toc-datasplittingresampling"><span class="toc-section-number">7.2</span> Data Splitting and Resampling</a>
<ul>
<li><a href="datasplittingresampling.html#datasplitting" id="toc-datasplitting"><span class="toc-section-number">7.2.1</span> Data Splitting</a></li>
<li><a href="datasplittingresampling.html#resampling" id="toc-resampling"><span class="toc-section-number">7.2.2</span> Resampling</a></li>
</ul></li>
</ul></li>
<li><a href="measuring-performance.html#measuring-performance" id="toc-measuring-performance"><span class="toc-section-number">8</span> Measuring Performance</a>
<ul>
<li><a href="regression-model-performance.html#regression-model-performance" id="toc-regression-model-performance"><span class="toc-section-number">8.1</span> Regression Model Performance</a></li>
<li><a href="classification-model-performance.html#classification-model-performance" id="toc-classification-model-performance"><span class="toc-section-number">8.2</span> Classification Model Performance</a>
<ul>
<li><a href="classification-model-performance.html#confusion-matrix" id="toc-confusion-matrix"><span class="toc-section-number">8.2.1</span> Confusion Matrix</a></li>
<li><a href="classification-model-performance.html#kappa-statistic" id="toc-kappa-statistic"><span class="toc-section-number">8.2.2</span> Kappa Statistic</a></li>
<li><a href="classification-model-performance.html#roc" id="toc-roc"><span class="toc-section-number">8.2.3</span> ROC</a></li>
<li><a href="classification-model-performance.html#gain-and-lift-charts" id="toc-gain-and-lift-charts"><span class="toc-section-number">8.2.4</span> Gain and Lift Charts</a></li>
</ul></li>
</ul></li>
<li><a href="regression-models.html#regression-models" id="toc-regression-models"><span class="toc-section-number">9</span> Regression Models</a>
<ul>
<li><a href="ordinary-least-square.html#ordinary-least-square" id="toc-ordinary-least-square"><span class="toc-section-number">9.1</span> Ordinary Least Square</a>
<ul>
<li><a href="ordinary-least-square.html#the-magic-p-value" id="toc-the-magic-p-value"><span class="toc-section-number">9.1.1</span> The Magic P-value</a></li>
<li><a href="ordinary-least-square.html#diagnostics-for-linear-regression" id="toc-diagnostics-for-linear-regression"><span class="toc-section-number">9.1.2</span> Diagnostics for Linear Regression</a></li>
</ul></li>
<li><a href="principal-component-regression-and-partial-least-square.html#principal-component-regression-and-partial-least-square" id="toc-principal-component-regression-and-partial-least-square"><span class="toc-section-number">9.2</span> Principal Component Regression and Partial Least Square</a></li>
</ul></li>
<li><a href="regularization-methods.html#regularization-methods" id="toc-regularization-methods"><span class="toc-section-number">10</span> Regularization Methods</a>
<ul>
<li><a href="ridge-regression.html#ridge-regression" id="toc-ridge-regression"><span class="toc-section-number">10.1</span> Ridge Regression</a></li>
<li><a href="lasso.html#lasso" id="toc-lasso"><span class="toc-section-number">10.2</span> LASSO</a></li>
<li><a href="elastic-net.html#elastic-net" id="toc-elastic-net"><span class="toc-section-number">10.3</span> Elastic Net</a></li>
<li><a href="penalized-generalized-linear-model.html#penalized-generalized-linear-model" id="toc-penalized-generalized-linear-model"><span class="toc-section-number">10.4</span> Penalized Generalized Linear Model</a>
<ul>
<li><a href="penalized-generalized-linear-model.html#introduction-to-glmnet-package" id="toc-introduction-to-glmnet-package"><span class="toc-section-number">10.4.1</span> Introduction to <code>glmnet</code> package</a></li>
<li><a href="penalized-generalized-linear-model.html#penalized-logistic-regression" id="toc-penalized-logistic-regression"><span class="toc-section-number">10.4.2</span> Penalized logistic regression</a></li>
</ul></li>
</ul></li>
<li><a href="treemodel.html#treemodel" id="toc-treemodel"><span class="toc-section-number">11</span> Tree-Based Methods</a>
<ul>
<li><a href="tree-basics.html#tree-basics" id="toc-tree-basics"><span class="toc-section-number">11.1</span> Tree Basics</a></li>
<li><a href="splitting-criteria.html#splitting-criteria" id="toc-splitting-criteria"><span class="toc-section-number">11.2</span> Splitting Criteria</a>
<ul>
<li><a href="splitting-criteria.html#gini-impurity" id="toc-gini-impurity"><span class="toc-section-number">11.2.1</span> Gini impurity</a></li>
<li><a href="splitting-criteria.html#information-gain-ig" id="toc-information-gain-ig"><span class="toc-section-number">11.2.2</span> Information Gain (IG)</a></li>
<li><a href="splitting-criteria.html#information-gain-ratio-igr" id="toc-information-gain-ratio-igr"><span class="toc-section-number">11.2.3</span> Information Gain Ratio (IGR)</a></li>
<li><a href="splitting-criteria.html#sum-of-squared-error-sse" id="toc-sum-of-squared-error-sse"><span class="toc-section-number">11.2.4</span> Sum of Squared Error (SSE)</a></li>
</ul></li>
<li><a href="tree-pruning.html#tree-pruning" id="toc-tree-pruning"><span class="toc-section-number">11.3</span> Tree Pruning</a></li>
<li><a href="regression-and-decision-tree-basic.html#regression-and-decision-tree-basic" id="toc-regression-and-decision-tree-basic"><span class="toc-section-number">11.4</span> Regression and Decision Tree Basic</a>
<ul>
<li><a href="regression-and-decision-tree-basic.html#regression-tree" id="toc-regression-tree"><span class="toc-section-number">11.4.1</span> Regression Tree</a></li>
<li><a href="regression-and-decision-tree-basic.html#decision-tree" id="toc-decision-tree"><span class="toc-section-number">11.4.2</span> Decision Tree</a></li>
</ul></li>
<li><a href="bagging-tree-1.html#bagging-tree-1" id="toc-bagging-tree-1"><span class="toc-section-number">11.5</span> Bagging Tree</a></li>
<li><a href="random-forest.html#random-forest" id="toc-random-forest"><span class="toc-section-number">11.6</span> Random Forest</a></li>
<li><a href="gradient-boosted-machine.html#gradient-boosted-machine" id="toc-gradient-boosted-machine"><span class="toc-section-number">11.7</span> Gradient Boosted Machine</a>
<ul>
<li><a href="gradient-boosted-machine.html#adaptive-boosting" id="toc-adaptive-boosting"><span class="toc-section-number">11.7.1</span> Adaptive Boosting</a></li>
<li><a href="gradient-boosted-machine.html#stochastic-gradient-boosting" id="toc-stochastic-gradient-boosting"><span class="toc-section-number">11.7.2</span> Stochastic Gradient Boosting</a></li>
</ul></li>
</ul></li>
<li><a href="deeplearning.html#deeplearning" id="toc-deeplearning"><span class="toc-section-number">12</span> Deep Learning</a>
<ul>
<li><a href="feedforward-neural-network.html#feedforward-neural-network" id="toc-feedforward-neural-network"><span class="toc-section-number">12.1</span> Feedforward Neural Network</a>
<ul>
<li><a href="feedforward-neural-network.html#logisticregasneuralnetwork" id="toc-logisticregasneuralnetwork"><span class="toc-section-number">12.1.1</span> Logistic Regression as Neural Network</a></li>
<li><a href="feedforward-neural-network.html#stochastic-gradient-descent" id="toc-stochastic-gradient-descent"><span class="toc-section-number">12.1.2</span> Stochastic Gradient Descent</a></li>
<li><a href="feedforward-neural-network.html#deepneuralnetwork" id="toc-deepneuralnetwork"><span class="toc-section-number">12.1.3</span> Deep Neural Network</a></li>
<li><a href="feedforward-neural-network.html#activationfunction" id="toc-activationfunction"><span class="toc-section-number">12.1.4</span> Activation Function</a></li>
<li><a href="feedforward-neural-network.html#optimization" id="toc-optimization"><span class="toc-section-number">12.1.5</span> Optimization</a></li>
<li><a href="feedforward-neural-network.html#deal-with-overfitting" id="toc-deal-with-overfitting"><span class="toc-section-number">12.1.6</span> Deal with Overfitting</a></li>
<li><a href="feedforward-neural-network.html#ffnnexample" id="toc-ffnnexample"><span class="toc-section-number">12.1.7</span> Image Recognition Using FFNN</a></li>
</ul></li>
<li><a href="convolutional-neural-network.html#convolutional-neural-network" id="toc-convolutional-neural-network"><span class="toc-section-number">12.2</span> Convolutional Neural Network</a>
<ul>
<li><a href="convolutional-neural-network.html#convolution-layer" id="toc-convolution-layer"><span class="toc-section-number">12.2.1</span> Convolution Layer</a></li>
<li><a href="convolutional-neural-network.html#padding-layer" id="toc-padding-layer"><span class="toc-section-number">12.2.2</span> Padding Layer</a></li>
<li><a href="convolutional-neural-network.html#pooling-layer" id="toc-pooling-layer"><span class="toc-section-number">12.2.3</span> Pooling Layer</a></li>
<li><a href="convolutional-neural-network.html#convolution-over-volume" id="toc-convolution-over-volume"><span class="toc-section-number">12.2.4</span> Convolution Over Volume</a></li>
<li><a href="convolutional-neural-network.html#cnnexample" id="toc-cnnexample"><span class="toc-section-number">12.2.5</span> Image Recognition Using CNN</a></li>
</ul></li>
<li><a href="recurrent-neural-network.html#recurrent-neural-network" id="toc-recurrent-neural-network"><span class="toc-section-number">12.3</span> Recurrent Neural Network</a>
<ul>
<li><a href="recurrent-neural-network.html#rnn-model" id="toc-rnn-model"><span class="toc-section-number">12.3.1</span> RNN Model</a></li>
<li><a href="recurrent-neural-network.html#lstm" id="toc-lstm"><span class="toc-section-number">12.3.2</span> Long Short Term Memory</a></li>
<li><a href="recurrent-neural-network.html#embedding" id="toc-embedding"><span class="toc-section-number">12.3.3</span> Word Embedding</a></li>
<li><a href="recurrent-neural-network.html#rnnexample" id="toc-rnnexample"><span class="toc-section-number">12.3.4</span> Sentiment Analysis Using RNN</a></li>
</ul></li>
</ul></li>
<li><a href="appendix.html#appendix" id="toc-appendix">Appendix</a></li>
<li><a href="largelocaldata.html#largelocaldata" id="toc-largelocaldata"><span class="toc-section-number">13</span> Handling Large Local Data</a>
<ul>
<li><a href="readr.html#readr" id="toc-readr"><span class="toc-section-number">13.1</span> <code>readr</code></a></li>
<li><a href="data.table-enhanced-data.html#data.table-enhanced-data.frame" id="toc-data.table-enhanced-data.frame"><span class="toc-section-number">13.2</span> <code>data.table</code>— enhanced <code>data.frame</code></a></li>
</ul></li>
<li><a href="r-code-for-data-simulation.html#r-code-for-data-simulation" id="toc-r-code-for-data-simulation"><span class="toc-section-number">14</span> R code for data simulation</a>
<ul>
<li><a href="appendixdata1.html#appendixdata1" id="toc-appendixdata1"><span class="toc-section-number">14.1</span> Customer Data for Clothing Company</a></li>
<li><a href="appendixdata3.html#appendixdata3" id="toc-appendixdata3"><span class="toc-section-number">14.2</span> Swine Disease Breakout Data</a></li>
</ul></li>
<li><a href="references.html#references" id="toc-references">References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Practitioner’s Guide to Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="convolutional-neural-network" class="section level2 hasAnchor" number="12.2">
<h2><span class="header-section-number">12.2</span> Convolutional Neural Network<a href="convolutional-neural-network.html#convolutional-neural-network" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There are some challenges using a feedforward neural network to solve computer vision problems. One of the challenges is that the inputs can get really big after you vectorize the image array. A 64 x 64 x 3 image gives you an input vector of 12288! And that is a very small image. So you can expect the number of parameters grows fast and it is difficult to get enough data to fit the model. Also as the input image size grows, the computational requirements to train a feedforward neural network will soon become infeasible. Also, after vectorization, you lose most of the spacial information of the image. To overcome these, people instead use the convolutional neural network for computer vision problems.</p>
<p>This section introduces the Convolutional Neural Network (CNN), the deep learning model that is almost universally used in computer vision applications. Computer vision has been advancing rapidly which enables many new applications such as self-driving cars and unlocking a phone using face. The application is not limited to the tech industry but some traditional industries such as agriculture and healthcare. Precision agriculture utilizes advanced hardware and computer vision algorithms to increase efficiency and reduce costs for farmers. For example, analyze images from cameras in the greenhouse to track plant growth state. Use sensory data from drones, satellites, and tractors to track soil conditions, detect herbs and pests, automate irrigation, etc. In health care, computer vision helps clinicians to diagnose disease, identify cancer sites with high accuracy <span class="citation">(<a href="#ref-gloria2019" role="doc-biblioref">Kwak and Hui 2019</a>)</span>. Even if you don’t work on computer vision, you may find some of the ideas inspiring and borrow them into your area.</p>
<p>Some popular computer vision problems are:</p>
<ul>
<li>Image classification (or image recognition): Recognize the object in the image. Is there a cat in the image? Who is this person?</li>
<li>Object detection: Detect the position and boarder of a specific object. For example, if you are building a self-driving car, you need to know the positions of other cars around you.</li>
<li>Neural Style Transfer (NST): Given a “content” image and a “style” image, generate an image that merges the two.</li>
</ul>
<div id="convolution-layer" class="section level3 hasAnchor" number="12.2.1">
<h3><span class="header-section-number">12.2.1</span> Convolution Layer<a href="convolutional-neural-network.html#convolution-layer" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A fundamental building block of the convolution neural network is, as the name indicates, the convolution operation. In this chapter, we illustrate the fundamentals of CNN using the example of image classification.</p>
<p>How do you do convolution? For example, you have a 5 x 5 2-d image (figure <a href="convolutional-neural-network.html#fig:convolution1">12.11</a>. You apply a 3 x 3 filter and convolute over the image. The output of this convolution operator will be a 3 x 3 matrix, which you can consider as a 3 x 3 image and visualize it (top right of figure <a href="convolutional-neural-network.html#fig:convolution1">12.11</a>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:convolution1"></span>
<img src="images/convolution1.png" alt="There are an input image (left), a filter (middel), and an output image (right)." width="80%" />
<p class="caption">
FIGURE 12.11: There are an input image (left), a filter (middel), and an output image (right).
</p>
</div>
<p>You start from the top left corner of the image and put the filter on the top left 3 x3 sub-matrix of the input image and take the element-wise product. Then you add up the 9 numbers. Move forward one step each time until it gets to the bottom right. The detailed process is shown in figure <a href="convolutional-neural-network.html#fig:convolutionsbs">12.12</a>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:convolutionsbs"></span>
<img src="images/convolutionsbs.png" alt="Convolution step by step" width="80%" />
<p class="caption">
FIGURE 12.12: Convolution step by step
</p>
</div>
<p>Let’s use edge detection as an example to see how convolution operation works. Given a picture as the left of figure <a href="convolutional-neural-network.html#fig:edgedetection">12.13</a>, you want to detect the vertical lines. For example, there are vertical lines along with the hair and the edges of the bookcase. How do you do that? There are standard filters for operations like blurring, sharpening, and edge detection. To get the edge, you can use the following 3 x 3 filter to convolute over the image.</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="convolutional-neural-network.html#cb352-1" aria-hidden="true" tabindex="-1"></a>kernel_vertical <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb352-2"><a href="convolutional-neural-network.html#cb352-2" aria-hidden="true" tabindex="-1"></a><span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb352-3"><a href="convolutional-neural-network.html#cb352-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-4"><a href="convolutional-neural-network.html#cb352-4" aria-hidden="true" tabindex="-1"></a>kernel_vertical</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]    1    0   -1
## [2,]    1    0   -1
## [3,]    1    0   -1</code></pre>
<p>The following code implements the convolution process. The result is shown as the middle of figure <a href="convolutional-neural-network.html#fig:edgedetection">12.13</a>.</p>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb354-1"><a href="convolutional-neural-network.html#cb354-1" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> magick<span class="sc">::</span><span class="fu">image_read</span>(<span class="st">&quot;http://bit.ly/2Nh5ANX&quot;</span>)</span>
<span id="cb354-2"><a href="convolutional-neural-network.html#cb354-2" aria-hidden="true" tabindex="-1"></a>kernel_vertical <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb354-3"><a href="convolutional-neural-network.html#cb354-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb354-4"><a href="convolutional-neural-network.html#cb354-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-5"><a href="convolutional-neural-network.html#cb354-5" aria-hidden="true" tabindex="-1"></a>kernel_horizontal <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb354-6"><a href="convolutional-neural-network.html#cb354-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> T)</span>
<span id="cb354-7"><a href="convolutional-neural-network.html#cb354-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-8"><a href="convolutional-neural-network.html#cb354-8" aria-hidden="true" tabindex="-1"></a>image_edge_vertical <span class="ot">=</span> magick<span class="sc">::</span><span class="fu">image_convolve</span>(image, kernel_vertical)</span>
<span id="cb354-9"><a href="convolutional-neural-network.html#cb354-9" aria-hidden="true" tabindex="-1"></a>image_edge_horizontal <span class="ot">=</span> magick<span class="sc">::</span><span class="fu">image_convolve</span>(image, kernel_horizontal)</span>
<span id="cb354-10"><a href="convolutional-neural-network.html#cb354-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-11"><a href="convolutional-neural-network.html#cb354-11" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb354-12"><a href="convolutional-neural-network.html#cb354-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-13"><a href="convolutional-neural-network.html#cb354-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(image)</span>
<span id="cb354-14"><a href="convolutional-neural-network.html#cb354-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(image_edge_vertical)</span>
<span id="cb354-15"><a href="convolutional-neural-network.html#cb354-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(image_edge_horizontal)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:edgedetection"></span>
<img src="images/edgedet5.png" alt="Edge Detection Example" width="100%" />
<p class="caption">
FIGURE 12.13: Edge Detection Example
</p>
</div>
<p>Why can <code>kernel_vertical</code> detect vertical edge? Let’s look at a simpler example. The following 8 x 8 matrix where half of the matrix is 10 and the other half is 0. The corresponding image is shown as the left of the figure <a href="convolutional-neural-network.html#fig:simpleedge">12.14</a>.</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="convolutional-neural-network.html#cb355-1" aria-hidden="true" tabindex="-1"></a>input_image <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">200</span>, <span class="dv">200</span>, <span class="dv">200</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">8</span>),</span>
<span id="cb355-2"><a href="convolutional-neural-network.html#cb355-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nrow =</span> <span class="dv">8</span>, <span class="at">byrow =</span> T)</span>
<span id="cb355-3"><a href="convolutional-neural-network.html#cb355-3" aria-hidden="true" tabindex="-1"></a>input_image</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
## [1,]  200  200  200  200    0    0    0    0
## [2,]  200  200  200  200    0    0    0    0
## [3,]  200  200  200  200    0    0    0    0
## [4,]  200  200  200  200    0    0    0    0
## [5,]  200  200  200  200    0    0    0    0
## [6,]  200  200  200  200    0    0    0    0
## [7,]  200  200  200  200    0    0    0    0
## [8,]  200  200  200  200    0    0    0    0</code></pre>
<p>If we use the above filter kernel_vertical , the output matrix is shown below and the corresponding image is shown as the right of the figure <a href="convolutional-neural-network.html#fig:simpleedge">12.14</a>.</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="convolutional-neural-network.html#cb357-1" aria-hidden="true" tabindex="-1"></a>output_image <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">200</span>, <span class="dv">200</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">6</span>),</span>
<span id="cb357-2"><a href="convolutional-neural-network.html#cb357-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nrow =</span> <span class="dv">6</span>, <span class="at">byrow =</span> T)</span>
<span id="cb357-3"><a href="convolutional-neural-network.html#cb357-3" aria-hidden="true" tabindex="-1"></a>output_image</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6]
## [1,]    0    0  200  200    0    0
## [2,]    0    0  200  200    0    0
## [3,]    0    0  200  200    0    0
## [4,]    0    0  200  200    0    0
## [5,]    0    0  200  200    0    0
## [6,]    0    0  200  200    0    0</code></pre>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:simpleedge"></span>
<img src="IDS_files/figure-html/simpleedge-1.svg" alt="Simple Edge Detection Example" width="80%" />
<p class="caption">
FIGURE 12.14: Simple Edge Detection Example
</p>
</div>
<p>So the output image has a lighter region in the middle that corresponds to the vertical edge of the input image. When the input image is large, such as the image in figure <a href="convolutional-neural-network.html#fig:edgedetection">12.13</a> is 1020 x 711, the edge will not seem as thick as it is in this small example. To detect the horizontal edge, you only need to rotate the filter by 90 degrees. The right image in figure <a href="convolutional-neural-network.html#fig:edgedetection">12.13</a> shows the horizontal edge detection result. You can see how convolution operator detects a specific feature from the image.</p>
<p>The parameters for the convolution operation are the elements in the filter. For a 3x3 filter shown below, the parameters to estimate are <span class="math inline">\(w_1\)</span> to <span class="math inline">\(w_9\)</span>. So far, we move the filter one step each time when we convolve. You can do more than 1 step as well. For example, you can hop 2 steps each time after the sum of the element-wise product. It is called strided-convolution. Use stride <span class="math inline">\(s\)</span> means the output is downsized by a factor of <span class="math inline">\(s\)</span>. It is rarely used in practice but it is good to be familiar with the concept.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:convolutionlayer"></span>
<img src="images/convlayer.png" alt="Convolution Layer Parameters" width="100%" />
<p class="caption">
FIGURE 12.15: Convolution Layer Parameters
</p>
</div>
</div>
<div id="padding-layer" class="section level3 hasAnchor" number="12.2.2">
<h3><span class="header-section-number">12.2.2</span> Padding Layer<a href="convolutional-neural-network.html#padding-layer" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Assume the stride is <span class="math inline">\(s\)</span> and we have a <span class="math inline">\(n \times n\)</span> input image to convolve with a <span class="math inline">\(f \times f\)</span> filter, the output image is <span class="math inline">\((\frac{n-f}{s} + 1) \times (\frac{n-f}{s} + 1)\)</span>. After each convolution, the dimension of the output shrinks. Depending on the size of the input image, the output size may get too small after a few rounds. Also, the pixel at the corner is used less than the pixel in the middle. So it overlooks some information in the image. To overcome these problems, you can add a padding layer during the process. To keep the output the same size as the input image in figure <a href="convolutional-neural-network.html#fig:convolutionlayer">12.15</a>, you can pad two pixels on each side of the image with 0 (figure <a href="convolutional-neural-network.html#fig:padding">12.16</a> ).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:padding"></span>
<img src="images/padding.png" alt="Padding Layer" width="100%" />
<p class="caption">
FIGURE 12.16: Padding Layer
</p>
</div>
<p>If the stride is <span class="math inline">\(s\)</span> and we have a <span class="math inline">\(n \times n\)</span> input image to convolve with a <span class="math inline">\(f \times f\)</span> filter. This time we pad <span class="math inline">\(p\)</span> pixels in each side, then the output size becomes <span class="math inline">\((\frac{n + 2p -f}{s} + 1) \times (\frac{n + 2p -f}{s} + 1)\)</span>. You can specify the value for p and also the pixel value used. Or you can just use 0 to pad and make the output the same size with input.</p>
</div>
<div id="pooling-layer" class="section level3 hasAnchor" number="12.2.3">
<h3><span class="header-section-number">12.2.3</span> Pooling Layer<a href="convolutional-neural-network.html#pooling-layer" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>People sometimes use the pooling layer to reduce the size of the representation and make some of the feature detection more robust. If you have a <span class="math inline">\(4 \times 4\)</span> input, the max and mean pooling operation are shown in the figure <a href="convolutional-neural-network.html#fig:poolinglayer">12.17</a>. The process is quite simple. In the example, the filter is <span class="math inline">\(2 \times 2\)</span> and stride is 2, so break the input into four <span class="math inline">\(2 \times 2\)</span> regions (shown in the figure with different shaded colors). For max pooling, each of the outputs is the maximum from the corresponding shaded sub-region. Mean pooling layer works in the same way except for getting the mean instead of maximum of the sub-region. The pooling layer has hyperparameters (<span class="math inline">\(f\)</span> and <span class="math inline">\(s\)</span>) but it has no parameter for gradient descent to learn.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:poolinglayer"></span>
<img src="images/poolinglayer.png" alt="Pooling Layer" width="100%" />
<p class="caption">
FIGURE 12.17: Pooling Layer
</p>
</div>
<p>Let’s go through an example of pooling a 2D grayscale image. Hope it gives you some intuition behind what it does. Read the image and convert the original color image (a 3D array) to grayscale (a 2D matrix).</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="convolutional-neural-network.html#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EBImage)</span>
<span id="cb359-2"><a href="convolutional-neural-network.html#cb359-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb359-3"><a href="convolutional-neural-network.html#cb359-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-4"><a href="convolutional-neural-network.html#cb359-4" aria-hidden="true" tabindex="-1"></a>eggshell <span class="ot">&lt;-</span> <span class="fu">readImage</span>(<span class="st">&quot;https://scientistcafe.com/images/eggshell.jpeg&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb359-5"><a href="convolutional-neural-network.html#cb359-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make it smaller</span></span>
<span id="cb359-6"><a href="convolutional-neural-network.html#cb359-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resize</span>(<span class="dv">560</span>, <span class="dv">420</span>) <span class="sc">%&gt;%</span></span>
<span id="cb359-7"><a href="convolutional-neural-network.html#cb359-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rotate image</span></span>
<span id="cb359-8"><a href="convolutional-neural-network.html#cb359-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rotate</span>(<span class="dv">90</span>)</span>
<span id="cb359-9"><a href="convolutional-neural-network.html#cb359-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-10"><a href="convolutional-neural-network.html#cb359-10" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to 2D grayscale</span></span>
<span id="cb359-11"><a href="convolutional-neural-network.html#cb359-11" aria-hidden="true" tabindex="-1"></a>gray_eggshell <span class="ot">=</span> <span class="fu">apply</span>(eggshell, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), mean)</span></code></pre></div>
<p>The following function takes an image matrix or array, and apply pooling operation.</p>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="convolutional-neural-network.html#cb360-1" aria-hidden="true" tabindex="-1"></a>pooling <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">type =</span> <span class="st">&quot;max&quot;</span>, image, filter, stride) {</span>
<span id="cb360-2"><a href="convolutional-neural-network.html#cb360-2" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> filter</span>
<span id="cb360-3"><a href="convolutional-neural-network.html#cb360-3" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> stride</span>
<span id="cb360-4"><a href="convolutional-neural-network.html#cb360-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-5"><a href="convolutional-neural-network.html#cb360-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">dim</span>(image)) <span class="sc">==</span> <span class="dv">3</span>) {</span>
<span id="cb360-6"><a href="convolutional-neural-network.html#cb360-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get image dimensions</span></span>
<span id="cb360-7"><a href="convolutional-neural-network.html#cb360-7" aria-hidden="true" tabindex="-1"></a>        col <span class="ot">&lt;-</span> <span class="fu">dim</span>(image[, , <span class="dv">1</span>])[<span class="dv">2</span>]</span>
<span id="cb360-8"><a href="convolutional-neural-network.html#cb360-8" aria-hidden="true" tabindex="-1"></a>        row <span class="ot">&lt;-</span> <span class="fu">dim</span>(image[, , <span class="dv">1</span>])[<span class="dv">1</span>]</span>
<span id="cb360-9"><a href="convolutional-neural-network.html#cb360-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate new dimension size</span></span>
<span id="cb360-10"><a href="convolutional-neural-network.html#cb360-10" aria-hidden="true" tabindex="-1"></a>        c <span class="ot">&lt;-</span> (col <span class="sc">-</span> f)<span class="sc">/</span>s <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb360-11"><a href="convolutional-neural-network.html#cb360-11" aria-hidden="true" tabindex="-1"></a>        r <span class="ot">&lt;-</span> (row <span class="sc">-</span> f)<span class="sc">/</span>s <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb360-12"><a href="convolutional-neural-network.html#cb360-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create new image object</span></span>
<span id="cb360-13"><a href="convolutional-neural-network.html#cb360-13" aria-hidden="true" tabindex="-1"></a>        newImage <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">c</span>(c, r, <span class="dv">3</span>))</span>
<span id="cb360-14"><a href="convolutional-neural-network.html#cb360-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># loops in RGB layers</span></span>
<span id="cb360-15"><a href="convolutional-neural-network.html#cb360-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (rgb <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb360-16"><a href="convolutional-neural-network.html#cb360-16" aria-hidden="true" tabindex="-1"></a>            m <span class="ot">&lt;-</span> image[, , rgb]</span>
<span id="cb360-17"><a href="convolutional-neural-network.html#cb360-17" aria-hidden="true" tabindex="-1"></a>            m3 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> c, <span class="at">nrow =</span> r)</span>
<span id="cb360-18"><a href="convolutional-neural-network.html#cb360-18" aria-hidden="true" tabindex="-1"></a>            i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb360-19"><a href="convolutional-neural-network.html#cb360-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">&quot;mean&quot;</span>)</span>
<span id="cb360-20"><a href="convolutional-neural-network.html#cb360-20" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> (ii <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>r) {</span>
<span id="cb360-21"><a href="convolutional-neural-network.html#cb360-21" aria-hidden="true" tabindex="-1"></a>                  j <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb360-22"><a href="convolutional-neural-network.html#cb360-22" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> (jj <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>c) {</span>
<span id="cb360-23"><a href="convolutional-neural-network.html#cb360-23" aria-hidden="true" tabindex="-1"></a>                    m3[ii, jj] <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">as.numeric</span>(m[i<span class="sc">:</span>(i <span class="sc">+</span></span>
<span id="cb360-24"><a href="convolutional-neural-network.html#cb360-24" aria-hidden="true" tabindex="-1"></a>                      (f <span class="sc">-</span> <span class="dv">1</span>)), j<span class="sc">:</span>(j <span class="sc">+</span> (f <span class="sc">-</span> <span class="dv">1</span>))]))</span>
<span id="cb360-25"><a href="convolutional-neural-network.html#cb360-25" aria-hidden="true" tabindex="-1"></a>                    j <span class="ot">&lt;-</span> j <span class="sc">+</span> s</span>
<span id="cb360-26"><a href="convolutional-neural-network.html#cb360-26" aria-hidden="true" tabindex="-1"></a>                  }</span>
<span id="cb360-27"><a href="convolutional-neural-network.html#cb360-27" aria-hidden="true" tabindex="-1"></a>                  i <span class="ot">&lt;-</span> i <span class="sc">+</span> s</span>
<span id="cb360-28"><a href="convolutional-neural-network.html#cb360-28" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">else</span> <span class="cf">for</span> (ii <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>r) {</span>
<span id="cb360-29"><a href="convolutional-neural-network.html#cb360-29" aria-hidden="true" tabindex="-1"></a>                j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb360-30"><a href="convolutional-neural-network.html#cb360-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> (jj <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>c) {</span>
<span id="cb360-31"><a href="convolutional-neural-network.html#cb360-31" aria-hidden="true" tabindex="-1"></a>                  m3[ii, jj] <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">as.numeric</span>(m[i<span class="sc">:</span>(i <span class="sc">+</span></span>
<span id="cb360-32"><a href="convolutional-neural-network.html#cb360-32" aria-hidden="true" tabindex="-1"></a>                    (f <span class="sc">-</span> <span class="dv">1</span>)), j<span class="sc">:</span>(j <span class="sc">+</span> (f <span class="sc">-</span> <span class="dv">1</span>))]))</span>
<span id="cb360-33"><a href="convolutional-neural-network.html#cb360-33" aria-hidden="true" tabindex="-1"></a>                  j <span class="ot">&lt;-</span> j <span class="sc">+</span> s</span>
<span id="cb360-34"><a href="convolutional-neural-network.html#cb360-34" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb360-35"><a href="convolutional-neural-network.html#cb360-35" aria-hidden="true" tabindex="-1"></a>                i <span class="ot">&lt;-</span> i <span class="sc">+</span> s</span>
<span id="cb360-36"><a href="convolutional-neural-network.html#cb360-36" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb360-37"><a href="convolutional-neural-network.html#cb360-37" aria-hidden="true" tabindex="-1"></a>            newImage[, , rgb] <span class="ot">&lt;-</span> m3</span>
<span id="cb360-38"><a href="convolutional-neural-network.html#cb360-38" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb360-39"><a href="convolutional-neural-network.html#cb360-39" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">dim</span>(image)) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb360-40"><a href="convolutional-neural-network.html#cb360-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get image dimensions</span></span>
<span id="cb360-41"><a href="convolutional-neural-network.html#cb360-41" aria-hidden="true" tabindex="-1"></a>        col <span class="ot">&lt;-</span> <span class="fu">dim</span>(image)[<span class="dv">2</span>]</span>
<span id="cb360-42"><a href="convolutional-neural-network.html#cb360-42" aria-hidden="true" tabindex="-1"></a>        row <span class="ot">&lt;-</span> <span class="fu">dim</span>(image)[<span class="dv">1</span>]</span>
<span id="cb360-43"><a href="convolutional-neural-network.html#cb360-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate new dimension size</span></span>
<span id="cb360-44"><a href="convolutional-neural-network.html#cb360-44" aria-hidden="true" tabindex="-1"></a>        c <span class="ot">&lt;-</span> (col <span class="sc">-</span> f)<span class="sc">/</span>s <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb360-45"><a href="convolutional-neural-network.html#cb360-45" aria-hidden="true" tabindex="-1"></a>        r <span class="ot">&lt;-</span> (row <span class="sc">-</span> f)<span class="sc">/</span>s <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb360-46"><a href="convolutional-neural-network.html#cb360-46" aria-hidden="true" tabindex="-1"></a>        m3 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> c, <span class="at">nrow =</span> r)</span>
<span id="cb360-47"><a href="convolutional-neural-network.html#cb360-47" aria-hidden="true" tabindex="-1"></a>        i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb360-48"><a href="convolutional-neural-network.html#cb360-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">&quot;mean&quot;</span>)</span>
<span id="cb360-49"><a href="convolutional-neural-network.html#cb360-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (ii <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>r) {</span>
<span id="cb360-50"><a href="convolutional-neural-network.html#cb360-50" aria-hidden="true" tabindex="-1"></a>                j <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb360-51"><a href="convolutional-neural-network.html#cb360-51" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> (jj <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>c) {</span>
<span id="cb360-52"><a href="convolutional-neural-network.html#cb360-52" aria-hidden="true" tabindex="-1"></a>                  m3[ii, jj] <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">as.numeric</span>(image[i<span class="sc">:</span>(i <span class="sc">+</span></span>
<span id="cb360-53"><a href="convolutional-neural-network.html#cb360-53" aria-hidden="true" tabindex="-1"></a>                    (f <span class="sc">-</span> <span class="dv">1</span>)), j<span class="sc">:</span>(j <span class="sc">+</span> (f <span class="sc">-</span> <span class="dv">1</span>))]))</span>
<span id="cb360-54"><a href="convolutional-neural-network.html#cb360-54" aria-hidden="true" tabindex="-1"></a>                  j <span class="ot">&lt;-</span> j <span class="sc">+</span> s</span>
<span id="cb360-55"><a href="convolutional-neural-network.html#cb360-55" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb360-56"><a href="convolutional-neural-network.html#cb360-56" aria-hidden="true" tabindex="-1"></a>                i <span class="ot">&lt;-</span> i <span class="sc">+</span> s</span>
<span id="cb360-57"><a href="convolutional-neural-network.html#cb360-57" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> <span class="cf">for</span> (ii <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>r) {</span>
<span id="cb360-58"><a href="convolutional-neural-network.html#cb360-58" aria-hidden="true" tabindex="-1"></a>            j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb360-59"><a href="convolutional-neural-network.html#cb360-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (jj <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>c) {</span>
<span id="cb360-60"><a href="convolutional-neural-network.html#cb360-60" aria-hidden="true" tabindex="-1"></a>                m3[ii, jj] <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">as.numeric</span>(image[i<span class="sc">:</span>(i <span class="sc">+</span></span>
<span id="cb360-61"><a href="convolutional-neural-network.html#cb360-61" aria-hidden="true" tabindex="-1"></a>                  (f <span class="sc">-</span> <span class="dv">1</span>)), j<span class="sc">:</span>(j <span class="sc">+</span> (f <span class="sc">-</span> <span class="dv">1</span>))]))</span>
<span id="cb360-62"><a href="convolutional-neural-network.html#cb360-62" aria-hidden="true" tabindex="-1"></a>                j <span class="ot">&lt;-</span> j <span class="sc">+</span> s</span>
<span id="cb360-63"><a href="convolutional-neural-network.html#cb360-63" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb360-64"><a href="convolutional-neural-network.html#cb360-64" aria-hidden="true" tabindex="-1"></a>            i <span class="ot">&lt;-</span> i <span class="sc">+</span> s</span>
<span id="cb360-65"><a href="convolutional-neural-network.html#cb360-65" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb360-66"><a href="convolutional-neural-network.html#cb360-66" aria-hidden="true" tabindex="-1"></a>        newImage <span class="ot">&lt;-</span> m3</span>
<span id="cb360-67"><a href="convolutional-neural-network.html#cb360-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb360-68"><a href="convolutional-neural-network.html#cb360-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(newImage)</span>
<span id="cb360-69"><a href="convolutional-neural-network.html#cb360-69" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s apply both max and mean pooling with filter size 10 (<span class="math inline">\(f = 10\)</span>) and stride 10 (<span class="math inline">\(s = 10\)</span>).</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="convolutional-neural-network.html#cb361-1" aria-hidden="true" tabindex="-1"></a>gray_eggshell_max <span class="ot">=</span> <span class="fu">pooling</span>(<span class="at">type =</span> <span class="st">&quot;max&quot;</span>,</span>
<span id="cb361-2"><a href="convolutional-neural-network.html#cb361-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">image =</span> gray_eggshell,</span>
<span id="cb361-3"><a href="convolutional-neural-network.html#cb361-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">filter =</span> <span class="dv">10</span>, <span class="at">stride =</span> <span class="dv">10</span>)</span>
<span id="cb361-4"><a href="convolutional-neural-network.html#cb361-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-5"><a href="convolutional-neural-network.html#cb361-5" aria-hidden="true" tabindex="-1"></a>gray_eggshell_mean <span class="ot">=</span> <span class="fu">pooling</span>(<span class="at">type =</span> <span class="st">&quot;mean&quot;</span>,</span>
<span id="cb361-6"><a href="convolutional-neural-network.html#cb361-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">image =</span> gray_eggshell,</span>
<span id="cb361-7"><a href="convolutional-neural-network.html#cb361-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">filter =</span> <span class="dv">10</span>, <span class="at">stride =</span> <span class="dv">10</span>)</span></code></pre></div>
<p>You can see the result by plotting the output image (figure <a href="convolutional-neural-network.html#fig:eggshellconv">12.18</a>). The top left is the original color picture. The top right is the 2D grayscale picture. The bottom left is the result of max pooling. The bottom right is the result of mean pooling. The max-pooling gives you the value of the largest pixel and the mean-pooling gives the average of the patch. You can consider it as a representation of features, looking at the maximal or average presence of different features. In general, max-pooling works better. You can gain some intuition from the example (figure <a href="convolutional-neural-network.html#fig:eggshellconv">12.18</a>). The max-pooling “picks” more distinct features and average-pooling blurs out features evenly.</p>
<div class="sourceCode" id="cb362"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb362-1"><a href="convolutional-neural-network.html#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb362-2"><a href="convolutional-neural-network.html#cb362-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(eggshell)</span>
<span id="cb362-3"><a href="convolutional-neural-network.html#cb362-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.Image</span>(gray_eggshell))</span>
<span id="cb362-4"><a href="convolutional-neural-network.html#cb362-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.Image</span>(gray_eggshell_max))</span>
<span id="cb362-5"><a href="convolutional-neural-network.html#cb362-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.Image</span>(gray_eggshell_mean))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:eggshellconv"></span>
<img src="images/eggshellconv.png" alt="Example of max and mean pooling" width="70%" />
<p class="caption">
FIGURE 12.18: Example of max and mean pooling
</p>
</div>
</div>
<div id="convolution-over-volume" class="section level3 hasAnchor" number="12.2.4">
<h3><span class="header-section-number">12.2.4</span> Convolution Over Volume<a href="convolutional-neural-network.html#convolution-over-volume" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>So far, we have shown different types of layers on 2D inputs. If you have a 3D input (such as a color image), then the filters will have 3 channels too. For example, if you have a <span class="math inline">\(6 \times 6\)</span> color image, the input dimension is <span class="math inline">\(6 \times 6 \times 3\)</span>. We call them the height, width, and the number of channels. The filter itself has 3 channels corresponding to the red, green, and blue channels of the input. You can consider it as a 3D cube with 27 parameters. Apply each channel of the filter to the corresponding channel of the input. Multiply each of the 27 numbers with the corresponding numbers from the top left region of the color input image and add them up. Add a bias parameter and apply an activation function which gives you the first number of the output image. Then slide it over to calculate the next one. The final output is 2D <span class="math inline">\(4 \times 4\)</span>. If you want to detect features in the red channel only, you can use a filter with the second and third channels to be all 0s. With different choices of the parameters, you can get different feature detectors. You can use more than one filter and each filter has multiple channels. For example, you can use one <span class="math inline">\(3 \times 3 \times 3\)</span> filter to detect the horizontal edge and another to detect the vertical edge. Figure <a href="convolutional-neural-network.html#fig:eggshellconv">12.18</a> shows an example of one layer with two filters. Each filter has a dimension of <span class="math inline">\(3 \times 3 \times 3\)</span>. The output dimension is <span class="math inline">\(4 \times 4 \times 2\)</span>. The output has two channels because we have two filters on the layer. The total number of parameters is 58 (each filter has one bias parameter <span class="math inline">\(b\)</span>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ConvOverVolume"></span>
<img src="images/ConvOverVolume.png" alt="Example of convolution over volume" width="70%" />
<p class="caption">
FIGURE 12.19: Example of convolution over volume
</p>
</div>
<p>We use the following notations for layer <span class="math inline">\(l\)</span>:</p>
<ul>
<li>Use <span class="math inline">\(n_W^{[l]}\)</span>, <span class="math inline">\(n_H^{[l]}\)</span> and <span class="math inline">\(n_C^{[l]}\)</span> to denote the width, height and number of channels of the input</li>
<li><span class="math inline">\(f^{[l]}\)</span> is the filter size</li>
<li><span class="math inline">\(p^{[l]}\)</span> is the padding size</li>
<li><span class="math inline">\(s^{[l]}\)</span> is the stride</li>
</ul>
<p>The number of filters for layer <span class="math inline">\(l\)</span> is the number of channels of the output of layer <span class="math inline">\(l\)</span>. Since the output of layer <span class="math inline">\(l\)</span> is the input of layer <span class="math inline">\(l+1\)</span>, the number of filters for layer <span class="math inline">\(l\)</span> is <span class="math inline">\(n_C^{[l+1]}\)</span>. The number of channels of the filter of layer <span class="math inline">\(l\)</span> should be equal to the number of channels of the input of layer <span class="math inline">\(l\)</span> which is the output of layer <span class="math inline">\(l-1\)</span> (i.e. <span class="math inline">\(n_C^{[l-1]}\)</span>). So the dimensions of some key elements of layer <span class="math inline">\(l\)</span> are:</p>
<ul>
<li>Each filter: <span class="math inline">\(f^{[l]} \times f^{[l]} \times n^{[l-1]}_C\)</span></li>
<li>Activations: <span class="math inline">\(a^{[l]} \rightarrow n_H^{[l]} \times n_W^{[l]} \times n_C^{[l]}\)</span></li>
<li>Weights: <span class="math inline">\(f^{[l]} \times f^{[l]} \times n^{[l-1]}_C \times n^{[l]}_C\)</span></li>
<li>bias: <span class="math inline">\(b^{[l]}_C\)</span></li>
<li>Input: <span class="math inline">\(n^{[l-1]}_H \times n^{[l-1]}_W \times n^{[l-1]}_C\)</span></li>
<li>Output: <span class="math inline">\(n^{[l]}_H \times n^{[l]}_W \times n^{[l]}_C\)</span></li>
</ul>
<p>After a series of 3D convolutional layers, we need to ‘flatten’ the 3D tensor to a 1D tensor, and add one or several dense layers to connect the output to the response variable.</p>
<p>Now you know the basic building blocks of CNN. Let’s look at how to use the keras R package to solve the same handwritten digits image recognition problem as in section <a href="feedforward-neural-network.html#ffnnexample">12.1.7</a>. You will see the CNN is better at handling image recognition problem.</p>
</div>
<div id="cnnexample" class="section level3 hasAnchor" number="12.2.5">
<h3><span class="header-section-number">12.2.5</span> Image Recognition Using CNN<a href="convolutional-neural-network.html#cnnexample" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>CNN leverages the relationship among neighbor pixels in the 2D image for better performance. It also avoids generating thousands or millions of features for high resolution images with full color. Now let’s import the MNIST dataset again as we have done some preprocessing specifically for FFNN before. CNN requires different preprocessing steps. Let’s start with a few parameters to be used later.</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="convolutional-neural-network.html#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the mnist data&#39;s training and testing dataset</span></span>
<span id="cb363-2"><a href="convolutional-neural-network.html#cb363-2" aria-hidden="true" tabindex="-1"></a>mnist <span class="ot">&lt;-</span> <span class="fu">dataset_mnist</span>()</span>
<span id="cb363-3"><a href="convolutional-neural-network.html#cb363-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="ot">&lt;-</span> mnist<span class="sc">$</span>train<span class="sc">$</span>x</span>
<span id="cb363-4"><a href="convolutional-neural-network.html#cb363-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> mnist<span class="sc">$</span>train<span class="sc">$</span>y</span>
<span id="cb363-5"><a href="convolutional-neural-network.html#cb363-5" aria-hidden="true" tabindex="-1"></a>x_test <span class="ot">&lt;-</span> mnist<span class="sc">$</span>test<span class="sc">$</span>x</span>
<span id="cb363-6"><a href="convolutional-neural-network.html#cb363-6" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> mnist<span class="sc">$</span>test<span class="sc">$</span>y</span>
<span id="cb363-7"><a href="convolutional-neural-network.html#cb363-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-8"><a href="convolutional-neural-network.html#cb363-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a few parameters to be used in the CNN model</span></span>
<span id="cb363-9"><a href="convolutional-neural-network.html#cb363-9" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">128</span></span>
<span id="cb363-10"><a href="convolutional-neural-network.html#cb363-10" aria-hidden="true" tabindex="-1"></a>num_classes <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb363-11"><a href="convolutional-neural-network.html#cb363-11" aria-hidden="true" tabindex="-1"></a>epochs <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb363-12"><a href="convolutional-neural-network.html#cb363-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-13"><a href="convolutional-neural-network.html#cb363-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Input image dimensions</span></span>
<span id="cb363-14"><a href="convolutional-neural-network.html#cb363-14" aria-hidden="true" tabindex="-1"></a>img_rows <span class="ot">&lt;-</span> <span class="dv">28</span></span>
<span id="cb363-15"><a href="convolutional-neural-network.html#cb363-15" aria-hidden="true" tabindex="-1"></a>img_cols <span class="ot">&lt;-</span> <span class="dv">28</span></span></code></pre></div>
<div id="data-preprocessing-1" class="section level4 hasAnchor" number="12.2.5.1">
<h4><span class="header-section-number">12.2.5.1</span> Data preprocessing<a href="convolutional-neural-network.html#data-preprocessing-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>For CNN, the input is a <span class="math inline">\(n_H \times n_W \times n_C\)</span> 3D array with <span class="math inline">\(n_C\)</span> channels. For example, a greyscale <span class="math inline">\(n_H \times n_W\)</span> image has only one channel, and the input is <span class="math inline">\(n_H \times n_W \times 1\)</span> tensor. A <span class="math inline">\(n_H \times n_W\)</span> 8-bit per channel RGB image has three channels with 3 <span class="math inline">\(n_H \times n_W\)</span> array with values between 0 and 255, so the input is <span class="math inline">\(n_H \times n_W \times 3\)</span> tensor. For the problem that we have now, the image is greyscaled, but we need to specifically define there is one channel by reshaping the 2D array into 3D tensor using <code>array_reshape()</code>. The <code>input_shape</code> variable will be used in the CNN model later. For an RGB color image, the number of channels is 3 and we need to replace “1” with “3” for the code cell below if the input image is RGB format.</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="convolutional-neural-network.html#cb364-1" aria-hidden="true" tabindex="-1"></a>x_train <span class="ot">&lt;-</span> <span class="fu">array_reshape</span>(x_train,</span>
<span id="cb364-2"><a href="convolutional-neural-network.html#cb364-2" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">c</span>(<span class="fu">nrow</span>(x_train), img_rows, img_cols, <span class="dv">1</span>))</span>
<span id="cb364-3"><a href="convolutional-neural-network.html#cb364-3" aria-hidden="true" tabindex="-1"></a>x_test <span class="ot">&lt;-</span> <span class="fu">array_reshape</span>(x_test,</span>
<span id="cb364-4"><a href="convolutional-neural-network.html#cb364-4" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">c</span>(<span class="fu">nrow</span>(x_test), img_rows, img_cols, <span class="dv">1</span>))</span>
<span id="cb364-5"><a href="convolutional-neural-network.html#cb364-5" aria-hidden="true" tabindex="-1"></a>input_shape <span class="ot">&lt;-</span> <span class="fu">c</span>(img_rows, img_cols, <span class="dv">1</span>)</span></code></pre></div>
<p>Here is the structure of the reshaped image, the first dimension is the image index, the 2-4 dimension is a 3D tensor even though there is only one channel.</p>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="convolutional-neural-network.html#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(x_train)</span></code></pre></div>
<div class="sourceCode" id="cb366"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb366-1"><a href="convolutional-neural-network.html#cb366-1" aria-hidden="true" tabindex="-1"></a>int [1:60000, 1:28, 1:28, 1] 0 0 0 0 0 0 0 0 0 0 ...</span></code></pre></div>
<p>Same as the FFNN model, we scale the input values to be between 0 and 1 for the same numerical stability consideration in the optimization process.</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="convolutional-neural-network.html#cb367-1" aria-hidden="true" tabindex="-1"></a>x_train <span class="ot">&lt;-</span> x_train <span class="sc">/</span> <span class="dv">255</span></span>
<span id="cb367-2"><a href="convolutional-neural-network.html#cb367-2" aria-hidden="true" tabindex="-1"></a>x_test <span class="ot">&lt;-</span> x_test <span class="sc">/</span> <span class="dv">255</span></span></code></pre></div>
<p>Encode the response variable to binary vectors.</p>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb368-1"><a href="convolutional-neural-network.html#cb368-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert class vectors to binary class matrices</span></span>
<span id="cb368-2"><a href="convolutional-neural-network.html#cb368-2" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(y_train, num_classes)</span>
<span id="cb368-3"><a href="convolutional-neural-network.html#cb368-3" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(y_test, num_classes)</span></code></pre></div>
</div>
<div id="fit-model-1" class="section level4 hasAnchor" number="12.2.5.2">
<h4><span class="header-section-number">12.2.5.2</span> Fit model<a href="convolutional-neural-network.html#fit-model-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>CNN model contains a series of 3D convolutional layers which contains a few parameters:</p>
<ol style="list-style-type: decimal">
<li><p>the kernal_size which is typically 3x3 or 5x5;</p></li>
<li><p>the number of filters, which is equal to the number of channels of the output;</p></li>
<li><p>activation function.</p></li>
</ol>
<p>For the first layer, there is also an input_shape parameter which is the input image size and channel. To prevent overfitting and speed up computation, a pooling layer is usually applied after one or a few convolutional layers. A maximum pooling layer with pool_size = 2x2 reduces the size to half. Dropout can be used as well in addition to pooling neighbor values. After a few 3D convolutional layers, we also need to ‘flatten’ the 3D tensor output into 1D tensor, and then add one or a couple of dense layers to connect the output to the target response classes.</p>
<p>Let’s define the CNN model structure. Now we define a CNN model with two convolutional layers, two max-pooling layers, and two dropout layers to mediate overfitting. There are three dense layers after flattening the 3D tensor. The last layer is a dense layer that connects to the response.</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb369-1"><a href="convolutional-neural-network.html#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define model structure</span></span>
<span id="cb369-2"><a href="convolutional-neural-network.html#cb369-2" aria-hidden="true" tabindex="-1"></a>cnn_model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb369-3"><a href="convolutional-neural-network.html#cb369-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">32</span>,</span>
<span id="cb369-4"><a href="convolutional-neural-network.html#cb369-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">5</span>),</span>
<span id="cb369-5"><a href="convolutional-neural-network.html#cb369-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>,</span>
<span id="cb369-6"><a href="convolutional-neural-network.html#cb369-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">input_shape =</span> input_shape) <span class="sc">%&gt;%</span></span>
<span id="cb369-7"><a href="convolutional-neural-network.html#cb369-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb369-8"><a href="convolutional-neural-network.html#cb369-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">64</span>,</span>
<span id="cb369-9"><a href="convolutional-neural-network.html#cb369-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">5</span>),</span>
<span id="cb369-10"><a href="convolutional-neural-network.html#cb369-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb369-11"><a href="convolutional-neural-network.html#cb369-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb369-12"><a href="convolutional-neural-network.html#cb369-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="at">rate =</span> <span class="fl">0.2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb369-13"><a href="convolutional-neural-network.html#cb369-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span></span>
<span id="cb369-14"><a href="convolutional-neural-network.html#cb369-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">120</span>, <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb369-15"><a href="convolutional-neural-network.html#cb369-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="at">rate =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb369-16"><a href="convolutional-neural-network.html#cb369-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">84</span>, <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb369-17"><a href="convolutional-neural-network.html#cb369-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> num_classes, <span class="at">activation =</span> <span class="st">&#39;softmax&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb370"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb370-1"><a href="convolutional-neural-network.html#cb370-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cnn_model)</span></code></pre></div>
<center>
<p><img src="images/cnn_summary.png" style="width:100.0%" />
</centerr></p>
<p>Similar to before, we need to compile the defined CNN model.</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb371-1"><a href="convolutional-neural-network.html#cb371-1" aria-hidden="true" tabindex="-1"></a>cnn_model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb371-2"><a href="convolutional-neural-network.html#cb371-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> loss_categorical_crossentropy,</span>
<span id="cb371-3"><a href="convolutional-neural-network.html#cb371-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_adadelta</span>(),</span>
<span id="cb371-4"><a href="convolutional-neural-network.html#cb371-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">&#39;accuracy&#39;</span>)</span>
<span id="cb371-5"><a href="convolutional-neural-network.html#cb371-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>We then train the model and save each epochs’s history using <code>fit()</code> function. Please note, as we are not using GPU, it takes a few minutes to finish. Please be patient while waiting for the results. The training time can be significantly reduced if running on GPU.</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="convolutional-neural-network.html#cb372-1" aria-hidden="true" tabindex="-1"></a>cnn_history <span class="ot">&lt;-</span> cnn_model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb372-2"><a href="convolutional-neural-network.html#cb372-2" aria-hidden="true" tabindex="-1"></a>  x_train, y_train,</span>
<span id="cb372-3"><a href="convolutional-neural-network.html#cb372-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb372-4"><a href="convolutional-neural-network.html#cb372-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> epochs,</span>
<span id="cb372-5"><a href="convolutional-neural-network.html#cb372-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span></span>
<span id="cb372-6"><a href="convolutional-neural-network.html#cb372-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The trained model accuracy can be evaluated on the testing dataset which is pretty good.</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb373-1"><a href="convolutional-neural-network.html#cb373-1" aria-hidden="true" tabindex="-1"></a>cnn_model <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(x_test, y_test)</span></code></pre></div>
<div class="sourceCode" id="cb374"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb374-1"><a href="convolutional-neural-network.html#cb374-1" aria-hidden="true" tabindex="-1"></a>##       loss   accuracy </span>
<span id="cb374-2"><a href="convolutional-neural-network.html#cb374-2" aria-hidden="true" tabindex="-1"></a>## 0.02301287 0.99300003</span></code></pre></div>
<p>There is some useful information stored in the output object <code>cnn_history</code> and the details can be shown by using <code>str()</code>. We can plot the training and validation accuracy and loss as function of epoch by simply calling <code>plot(cnn_history)</code>.</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb375-1"><a href="convolutional-neural-network.html#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(cnn_history)</span></code></pre></div>
<div class="sourceCode" id="cb376"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb376-1"><a href="convolutional-neural-network.html#cb376-1" aria-hidden="true" tabindex="-1"></a>## List of 2</span>
<span id="cb376-2"><a href="convolutional-neural-network.html#cb376-2" aria-hidden="true" tabindex="-1"></a>##  $ params :List of 3</span>
<span id="cb376-3"><a href="convolutional-neural-network.html#cb376-3" aria-hidden="true" tabindex="-1"></a>##   ..$ verbose: int 1</span>
<span id="cb376-4"><a href="convolutional-neural-network.html#cb376-4" aria-hidden="true" tabindex="-1"></a>##   ..$ epochs : int 10</span>
<span id="cb376-5"><a href="convolutional-neural-network.html#cb376-5" aria-hidden="true" tabindex="-1"></a>##   ..$ steps  : int 375</span>
<span id="cb376-6"><a href="convolutional-neural-network.html#cb376-6" aria-hidden="true" tabindex="-1"></a>##  $ metrics:List of 4</span>
<span id="cb376-7"><a href="convolutional-neural-network.html#cb376-7" aria-hidden="true" tabindex="-1"></a>##   ..$ loss        : num [1:10] 0.3415 0.0911 0.0648 0.0504 0.0428 ...</span>
<span id="cb376-8"><a href="convolutional-neural-network.html#cb376-8" aria-hidden="true" tabindex="-1"></a>##   ..$ accuracy    : num [1:10] 0.891 0.973 0.981 0.985 0.987 ...</span>
<span id="cb376-9"><a href="convolutional-neural-network.html#cb376-9" aria-hidden="true" tabindex="-1"></a>##   ..$ val_loss    : num [1:10] 0.071 0.0515 0.0417 0.0377 0.0412 ...</span>
<span id="cb376-10"><a href="convolutional-neural-network.html#cb376-10" aria-hidden="true" tabindex="-1"></a>##   ..$ val_accuracy: num [1:10] 0.978 0.985 0.988 0.99 0.988 ...</span>
<span id="cb376-11"><a href="convolutional-neural-network.html#cb376-11" aria-hidden="true" tabindex="-1"></a>##  - attr(*, &quot;class&quot;)= chr &quot;keras_training_history&quot;</span></code></pre></div>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb377-1"><a href="convolutional-neural-network.html#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cnn_history)</span></code></pre></div>
<center>
<img src="images/cnn_history.png" style="width:90.0%" />
</center>
</div>
<div id="prediction-1" class="section level4 hasAnchor" number="12.2.5.3">
<h4><span class="header-section-number">12.2.5.3</span> Prediction<a href="convolutional-neural-network.html#prediction-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We can apply the trained model to predict new image.</p>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb378-1"><a href="convolutional-neural-network.html#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model prediction</span></span>
<span id="cb378-2"><a href="convolutional-neural-network.html#cb378-2" aria-hidden="true" tabindex="-1"></a>cnn_pred <span class="ot">&lt;-</span> cnn_model <span class="sc">%&gt;%</span></span>
<span id="cb378-3"><a href="convolutional-neural-network.html#cb378-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(x_test) <span class="sc">%&gt;%</span></span>
<span id="cb378-4"><a href="convolutional-neural-network.html#cb378-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">k_argmax</span>()</span>
<span id="cb378-5"><a href="convolutional-neural-network.html#cb378-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-6"><a href="convolutional-neural-network.html#cb378-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cnn_pred)</span></code></pre></div>
<div class="sourceCode" id="cb379"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb379-1"><a href="convolutional-neural-network.html#cb379-1" aria-hidden="true" tabindex="-1"></a>## tf.Tensor([7 2 1 0 4 1], shape=(6,), dtype=int64)</span></code></pre></div>
<p>Now let’s check a few misclassified images to see whether a human can do a better job than this simple CNN model.</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb380-1"><a href="convolutional-neural-network.html#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Convert tf.tensor to array</span></span>
<span id="cb380-2"><a href="convolutional-neural-network.html#cb380-2" aria-hidden="true" tabindex="-1"></a>cnn_pred <span class="ot">&lt;-</span> <span class="fu">as.array</span>(cnn_pred)</span>
<span id="cb380-3"><a href="convolutional-neural-network.html#cb380-3" aria-hidden="true" tabindex="-1"></a><span class="do">## number of mis-classcified images</span></span>
<span id="cb380-4"><a href="convolutional-neural-network.html#cb380-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(cnn_pred <span class="sc">!=</span> mnist<span class="sc">$</span>test<span class="sc">$</span>y)</span></code></pre></div>
<div class="sourceCode" id="cb381"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb381-1"><a href="convolutional-neural-network.html#cb381-1" aria-hidden="true" tabindex="-1"></a>## [1] 70</span></code></pre></div>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb382-1"><a href="convolutional-neural-network.html#cb382-1" aria-hidden="true" tabindex="-1"></a>missed_image <span class="ot">=</span> mnist<span class="sc">$</span>test<span class="sc">$</span>x[cnn_pred <span class="sc">!=</span> mnist<span class="sc">$</span>test<span class="sc">$</span>y,,]</span>
<span id="cb382-2"><a href="convolutional-neural-network.html#cb382-2" aria-hidden="true" tabindex="-1"></a>missed_digit <span class="ot">=</span> mnist<span class="sc">$</span>test<span class="sc">$</span>y[cnn_pred <span class="sc">!=</span> mnist<span class="sc">$</span>test<span class="sc">$</span>y]</span>
<span id="cb382-3"><a href="convolutional-neural-network.html#cb382-3" aria-hidden="true" tabindex="-1"></a>missed_pred <span class="ot">=</span> cnn_pred[cnn_pred <span class="sc">!=</span> mnist<span class="sc">$</span>test<span class="sc">$</span>y]</span></code></pre></div>
<div class="sourceCode" id="cb383"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb383-1"><a href="convolutional-neural-network.html#cb383-1" aria-hidden="true" tabindex="-1"></a>index_image <span class="ot">=</span> <span class="dv">10</span> <span class="do">## change this index to see different image.</span></span>
<span id="cb383-2"><a href="convolutional-neural-network.html#cb383-2" aria-hidden="true" tabindex="-1"></a>input_matrix <span class="ot">&lt;-</span> missed_image[index_image,<span class="dv">1</span><span class="sc">:</span><span class="dv">28</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">28</span>]</span>
<span id="cb383-3"><a href="convolutional-neural-network.html#cb383-3" aria-hidden="true" tabindex="-1"></a>output_matrix <span class="ot">&lt;-</span> <span class="fu">apply</span>(input_matrix, <span class="dv">2</span>, rev)</span>
<span id="cb383-4"><a href="convolutional-neural-network.html#cb383-4" aria-hidden="true" tabindex="-1"></a>output_matrix <span class="ot">&lt;-</span> <span class="fu">t</span>(output_matrix)</span>
<span id="cb383-5"><a href="convolutional-neural-network.html#cb383-5" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">28</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">28</span>, output_matrix, <span class="at">col=</span><span class="fu">gray.colors</span>(<span class="dv">256</span>),</span>
<span id="cb383-6"><a href="convolutional-neural-network.html#cb383-6" aria-hidden="true" tabindex="-1"></a><span class="at">xlab=</span><span class="fu">paste</span>(<span class="st">&#39;Image for digit &#39;</span>, missed_digit[index_image], <span class="st">&#39;,</span></span>
<span id="cb383-7"><a href="convolutional-neural-network.html#cb383-7" aria-hidden="true" tabindex="-1"></a><span class="st">wrongly predicted as &#39;</span>, missed_pred[index_image]), <span class="at">ylab=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
<center>
<img src="images/misclassified_img_cnn.png" style="width:70.0%" />
</center>
</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-gloria2019" class="csl-entry">
Kwak, Gloria Hyun Jung, and Pan Hui. 2019. <span>“DeepHealth: Deep Learning for Health Informatics Reviews, Challenges, and Opportunities on Medical Imaging, Electronic Health Records, Genomics, Sensing, and Online Communication Health.”</span> 2019.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="feedforward-neural-network.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="recurrent-neural-network.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": true,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/happyrabbit/IntroDataScience/12-DeepLearning.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["IDS.pdf", "IDS.epub", "IDS.mobi"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
