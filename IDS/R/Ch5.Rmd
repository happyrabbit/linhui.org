---
title: "Chapter 5 Data Pre-processing"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

This notebook illustrates how to perform standard data pre-processing, an essential step for any data science projects. 

# Load R Packages and Data

```{r, message = FALSE, warning=FALSE, results='hide'}
# install packages
p_needed <- c('imputeMissings','caret','e1071','psych','car','corrplot','RANN')
packages <- rownames(installed.packages())
p_to_install <- p_needed[!(p_needed %in% packages)]

if (length(p_to_install) > 0) {
    install.packages(p_to_install)
}

lapply(p_needed, require, character.only = TRUE)
```


```{r}
# load the simulated dataset and return summary statistics for each column
sim.dat <- read.csv("http://bit.ly/2P5gTw4")
summary(sim.dat)
```

# Deal with Problematic Data

Set the problematic values as missing and impute them later.

```{r}
# set problematic values as missings
sim.dat$age[which(sim.dat$age > 100)] <- NA
sim.dat$store_exp[which(sim.dat$store_exp < 0)] <- NA
# see the results
summary(subset(sim.dat, select = c("age", "store_exp")))
```

#  Deal with Missing Values

Missing values are common in the raw data set. Based on the mechanism behind missing values, we have a few different ways to impute missing values.

First, let's use the `impute()` function from `imputeMissing` package with `method = "median/mode"`.

```{r}
# save the result as another object 
# !!! has to add imputeMissings::
demo_imp <- imputeMissings::impute(sim.dat, method = "median/mode")

# check the first five columns. 
# There are no missing values in other columns
summary(demo_imp[, 1:5])
```

We can also use `preProcess()` function from `caret` package with  `method = "medianImpute"`.

```{r}
imp <- preProcess(sim.dat, method = "medianImpute")
demo_imp2 <- predict(imp, sim.dat)
summary(demo_imp2[, 1:5])
```

Use preProcess() to conduct KNN:

```{r}
## Please note, to use knnImpute you have to install.packages('RANN') 
# !!! have to install RANN package
imp <- preProcess(sim.dat, method = "knnImpute", k = 5)

# need to use predict() to get KNN result
demo_imp <- predict(imp, sim.dat)

# only show the first three elements 
# !!! below line changed !!!
lapply(demo_imp, summary)[1:3]
```

The `preProcess()`  will automatically ignore non-numeric columns. When all the columns for a row are missing, then KNN method will fail. For example, the following codes will return an error. In this case, we can identify rows with all columns missing and remove them from the dataset.

```{r}
temp <- rbind(sim.dat, rep(NA, ncol(sim.dat)))
imp <- preProcess(sim.dat, method = "knnImpute", k = 5)
```

```r
demo_imp <- predict(imp, temp)
```

```html
Error in FUN(newX[, i], ...) : 
  cannot impute when all predictors are missing in the new data point
```

There is an error saying “`cannot impute when all predictors are missing in the new data point`”. It is easy to fix by finding and removing the problematic row(s):

```{r}
idx <- apply(temp, 1, function(x) sum(is.na(x)))
as.vector(which(idx == ncol(temp)))
```

It shows that row 1001 is problematic. We can go ahead to delete it.

Finally, let us try the "`bagImpute`" method, which is more time-consuming.

```{r}
imp <- preProcess(sim.dat, method = "bagImpute")
demo_imp <- predict(imp, sim.dat)
summary(demo_imp[, 1:5])
```

# Centering and Scaling
